# 多功能生化測試儀概述

## 系統介紹

多功能生化測試儀(P14_BLE-GAV_V2.1)是一款便攜式生化分析裝置，可測量多種生化指標，包括血糖、尿酸、膽固醇和三酸甘油脂等。系統由硬體裝置(Meter)和手機應用程式(APP)兩部分組成，透過藍牙進行通訊。

## 硬體架構

### 主要元件
- **處理晶片**：
  - CH582F：負責藍牙通訊，並偵測試片插入或移除
  - CH32V203G8R6：負責生化測量
- **電源供應**：CR2032 鈕扣電池
- **通訊介面**：
  - 內部：CH32V203與CH582F之間透過UART連接
  - 外部：CH582F與手機APP之間透過藍牙連接
- **輸入介面**：試片插槽，支援多種試片類型

### 試片類型識別
裝置支援的試片類型及識別機制如下：

| 試片類型 | 接腳短路模式 | 測量項目 |
|---------|------------|---------|
| GLV | 接腳 3、4 短路 | 血糖(GLV試片) |
| U | 接腳 1、3、4 短路 | 尿酸 |
| C | 接腳 3、4、5 短路 | 總膽固醇 |
| TG | 接腳 1、4、5 短路 | 三酸甘油脂 |
| GAV | 接腳 4、5 短路 | 血糖(GAV試片) |

## 操作流程

### 基本測試流程
1. **準備階段**
   - 開啟手機藍牙
   - 啟動APP
   - 準備適當的測試試片

2. **啟動測試**
   - 插入試片，Meter會自動開機
   - APP自動掃描並連接Meter

3. **測試前準備**
   - APP將手機時間同步到Meter
   - 系統自動檢查裝置狀態
   - 使用者設定CODE和EVENT參數

4. **測試執行**
   - 等待滴血提示
   - 採血並滴到試片指定位置
   - Meter檢測到血液後開始倒數計時

5. **結果顯示**
   - 測試完成後，結果傳送到APP
   - APP顯示測試數值及相關資訊
   - 工廠模式下還會顯示RAW DATA詳細資訊

6. **測試完成**
   - 結果自動保存到歷史記錄
   - 使用者移除試片，Meter自動關機

## 通訊協議

### 藍牙通訊規範
- **裝置名稱**：P14-xxxxxx (xxxxxx為MAC地址後6位)
- **服務UUID**：0xFFE0
- **特性UUID**：
  - 接收通知：0xFFE1 (可寫入，帶回應)
  - 發送通知：0xFFE2 (帶通知)
- **MTU大小**：20 bytes
- **連接間隔**：30-50ms

### 通訊封包格式
所有通訊均使用以下封包格式：
- 起始標記 (1 byte)：固定為 0xAA
- 指令ID (1 byte)：指定操作類型
- 長度 (1 byte)：資料欄位的長度
- 資料 (N bytes)：依指令ID不同而變化
- 校驗和 (1 byte)：從指令ID到資料欄位最後一位的和取模256
- 結束標記 (1 byte)：固定為 0x55

### 主要指令集
| 指令ID | 名稱 | 方向 | 描述 |
|------|------|------|------|
| 0x01/0x81 | 同步時間 | APP→Meter/Meter→APP | 設定日期時間及確認 |
| 0x02/0x82 | 裝置狀態 | APP→Meter/Meter→APP | 請求與返回裝置狀態 |
| 0x03/0x83 | CODE/EVENT設定 | APP→Meter/Meter→APP | 設定測試參數及確認 |
| 0x04/0x84 | 檢測狀態 | APP→Meter/Meter→APP | 查詢與通知血液檢測 |
| 0x05/0x85 | 測試結果 | APP→Meter/Meter→APP | 請求與返回測量結果 |
| 0x06/0x86 | RAW DATA | APP→Meter/Meter→APP | 請求與返回原始數據 |
| 0xFF | 錯誤回應 | Meter→APP | 通用錯誤回應 |

## 異常處理

### 常見錯誤及處理方法
- **電池電量過低**：更換CR2032電池
- **溫度異常**：將裝置移至適合的操作溫度環境(10-40°C)
- **試片異常**：更換新的試片，確保正確插入
- **通訊錯誤**：確認Meter是否開機，嘗試重新連接或重啟APP
- **血液樣本不足**：使用新試片，確保血液樣本足夠

### 錯誤代碼
系統使用統一的錯誤代碼機制，透過錯誤代碼APP可以向使用者顯示具體問題並提供相應解決方案。

## 資料儲存

- 裝置使用CH32V203的Flash儲存參數及測試記錄
- 採用雙參數區(A/B)備份機制確保資料安全
- 最多可儲存約1152筆測試記錄

## 工廠模式

工廠模式提供額外的功能，主要用於生產測試與校準：
- 顯示RAW DATA詳細技術資訊
- 包括ADC值、振幅等技術數據
- 提供更多測試與校準選項

這款多功能生化測試儀結合了精確的生化測量技術與現代無線通訊技術，適合用於多種生化指標的居家快速測量。
