# 多功能生化測試儀試片類型判別機制

## 1. 接腳定義與試片類型判別

多功能生化測試儀 (P14_BLE-GAV_V2.1) 採用智慧型試片插槽設計，透過檢測試片接腳之間的短路模式以及測量電壓來自動識別不同類型的試片。這種設計讓使用者無需手動選擇測試類型，提高了操作便利性與減少人為錯誤的可能性。

### 1.1 基本腳位設計

試片插槽採用 5 腳設計，第4腳直接接地，其他各腳具有特定功能：

| 腳位 | 功能 |
|------|------|
| 腳位 1 | 連接到 T1_IN，用於判別第1腳是否與接地腳位短路 |
| 腳位 2 | 未在判別機制中使用 |
| 腳位 3 | 連接到 Strip_Detect_3，用於喚醒系統並判別試片類型 |
| 腳位 4 | 直接接地，作為參考電位 |
| 腳位 5 | 連接到 Strip_Detect_5，用於喚醒系統並判別試片類型 |

### 1.2 試片類型及判別機制

每種試片類型都有特定的接腳短路模式，透過檢測第3/5腳的High/Low準位以及T1_OUT電壓來判別：

| 試片類型 | 接腳短路模式 | 第3腳狀態 | 第5腳狀態 | T1_OUT電壓 | 測量項目 |
|---------|------------|---------|----------|-----------|---------|
| GLV | 3、4短路 | Low | High | 接近2.5V | 血糖(GLV試片) |
| U | 1、3、4短路 | Low | High | 接近0V | 尿酸 |
| C | 3、4、5短路 | Low | Low | 接近2.5V | 總膽固醇 |
| TG | 1、4、5短路 | High | Low | 接近0V | 三酸甘油脂 |
| GAV | 4、5短路 | High | Low | 接近2.5V | 血糖(GAV試片) |

## 2. 試片檢測與喚醒流程

### 2.1 喚醒機制

1. **系統低功耗狀態**：
   - 未插入試片時，系統處於低功耗狀態
   - Strip_Detect_3和Strip_Detect_5設定為上拉輸入模式

2. **插入試片觸發**：
   - 當試片插入時，第4腳（已接地）與第3/5腳接觸
   - 導致Strip_Detect_3或Strip_Detect_5被拉低
   - 觸發中斷喚醒BLE晶片(CH582F)
   - CH582F喚醒主MCU(CH32V203)

### 2.2 試片類型判定流程

1. **初始化判別電路**：
   - 系統喚醒後初始化判別電路
   - 啟用T1測量電路（T1_ENABLE設為Low）

2. **第一階段：檢測第3/5腳狀態**：
   - 讀取Strip_Detect_3電位（High或Low）
   - 讀取Strip_Detect_5電位（High或Low）

3. **第二階段：測量T1_OUT電壓**：
   - 透過ADC讀取T1_OUT電壓值
   - 判斷是否接近2.5V或接近0V
   - 接近2.5V表示第1腳未與接地腳短路
   - 接近0V表示第1腳與接地腳短路

4. **綜合判別**：
   - 結合第3/5腳狀態與T1_OUT電壓
   - 依據判別邏輯表確定試片類型

### 2.3 測試準備

- 確認試片類型後，系統載入相應的測試參數
- 應用程式顯示已識別的測試項目，供使用者確認
- 系統準備開始測試流程

## 3. 血飽偵測機制

不同試片類型採用不同的血飽偵測機制：

| 試片類型 | 血飽偵測方式 |
|---------|------------|
| GAV | T3 電極（第 3 腳） |
| 其他試片 | WE 電極（第 2 腳） |

## 4. 技術規格

### 4.1 試片接腳電氣特性

- **工作電壓**：根據參數表 EV_WORKING 設定，一般為 164 (約 0.4V)
- **T3 觸發電壓**：可調整範圍 400mV ~ 2500mV
- **T1參考電壓**：2.5V
- **新/舊試片檢測**：每種試片類型都有對應的 NDL/UDL 參數

### 4.2 相關硬體連接

- **試片插入檢測**：
  - Strip_Detect_3 連接到 CH582F 的 PB11/UD+/TMR2_ 引腳
  - Strip_Detect_5 連接到 CH582F 的 PA15/MISO/RXD0_/AIN5 引腳
  - 這兩個引腳都設定為上拉輸入模式(GPIO_Mode_IPU)

- **T1測量電路**：
  - T1_IN 連接到試片第1腳
  - T1_ENABLE 連接到 CH32V203 的 PA8/TIM1_CH1 引腳（Low Enable）
  - T1_OUT 連接到 CH32V203 的 PA6/ADC6/OP1N1 引腳，用於ADC測量

- **T3電極控制**：
  - T3_IN_SEL 連接到 CH582F 的 PB10/UD-/TMR1_ 引腳（High Enable）
  - T3_ADC 連接到 CH32V203 的 PB0/ADC8/OP1P1 引腳，用於測量GAV試片的T3電極電壓

- **WE電極控制**：
  - WE_ENABLE 連接到 CH32V203 的 PB15/OP1P0/TIM1_CH3N 引腳，控制W電極電壓的PWM

## 5. 判別邏輯實現

### 5.1 程式流程

```
1. 檢測試片插入（透過第3或第5腳的中斷）
2. 初始化系統，啟用T1測量電路
3. 讀取第3腳狀態（Strip_Detect_3）
4. 讀取第5腳狀態（Strip_Detect_5）
5. 讀取T1_OUT電壓（ADC轉換值）
6. 根據讀取結果判斷試片類型：
   IF 第3腳==Low AND 第5腳==High AND T1_OUT接近2.5V THEN
       試片類型 = GLV（血糖）
   ELSE IF 第3腳==Low AND 第5腳==High AND T1_OUT接近0V THEN
       試片類型 = U（尿酸）
   ELSE IF 第3腳==Low AND 第5腳==Low AND T1_OUT接近2.5V THEN
       試片類型 = C（總膽固醇）
   ELSE IF 第3腳==High AND 第5腳==Low AND T1_OUT接近0V THEN
       試片類型 = TG（三酸甘油脂）
   ELSE IF 第3腳==High AND 第5腳==Low AND T1_OUT接近2.5V THEN
       試片類型 = GAV（血糖GAV）
   ELSE
       試片類型 = 未知（錯誤）
7. 若為GAV試片，可進行額外阻抗測量確認
8. 根據判定的試片類型載入相應測試參數
9. 開始測試流程
```

### 5.2 ADC判定閾值設定

對於12位ADC（0-4095範圍）:
- ADC值 < 500：判定為「接近0V」
- ADC值 > 3000：判定為「接近2.5V」

## 6. T1測量電路工作原理

T1測量電路為試片類型判別提供額外確認機制：

1. **未短路狀態**：
   - 當第1腳未與其他接地腳位短路時
   - T1_IN維持在2.5V參考電壓
   - T1_OUT輸出接近2.5V

2. **短路狀態**：
   - 當第1腳與接地腳位（如第4腳）短路時
   - T1_IN被拉低至接近0V
   - T1_OUT輸出接近0V

這種雙重確認機制（腳位+電壓測量）確保了試片類型判別的準確性與可靠性，即使在不同試片類型具有相似短路模式的情況下也能準確區分。

## 7. 阻抗識別與補償

系統不僅通過腳位短路和電壓測量來識別試片類型，對於GAV試片還進行阻抗測量，用於：

1. **進一步確認試片類型**
2. **評估血液品質**
3. **校準測量補償參數**

這種多層確認機制確保了測試結果的準確性與可靠性。