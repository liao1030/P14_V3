flowchart TD
    A[USART2 中嘤|l] --> B{中囝型z查}
    B -->|IDLE 中| C[UART 空f路zy]
    C --> C1[算接收Y料L度<br/>RX_BUFFER_LEN - DMA_CNTR]
    C1 --> C2[浞莓前n^颂]
    C2 --> C3[切Q DMA 使用n^<br/>pnC制]
    C3 --> C4[停用 DMA Channel6]
    C4 --> C5[重O DMA 灯]
    C5 --> C6[更新 DMA w位址<br/>指向新n^]
    C6 --> C7[重新 DMA]
    C7 --> C8[清除 IDLE 苏I<br/>x取 USART_DR]
    C8 --> C9[①Y料推入h形n^<br/>ring_buffer_push_huge]
    C9 --> C10[逐位元M理接收Y料<br/>呼叫 UART2_Receive_Byte_ISR]
    C10 --> M[中喾祷]
    
    B -->|RXNE 中| D[挝辉M接收中]
    D --> D1[x取接收位元M<br/>USART_ReceiveData]
    D1 --> D2[呼叫fh理<br/>UART2_Receive_Byte_ISR]
    D2 --> M
    
    N[DMA1 Channel6 中嘤|l] --> O[DMA n^M事件]
    O --> O1[O定接收L度<br/>RX_BUFFER_LEN]
    O1 --> O2[浞莓前n^颂]
    O2 --> O3[切Q到另一n^]
    O3 --> O4[停用 DMA]
    O4 --> O5[重O DMA 灯]
    O5 --> O6[更新 DMA w位址]
    O6 --> O7[重新 DMA]
    O7 --> O8[⑼暾n^Y料<br/>推入h形n^]
    O8 --> O9[逐位元M理Y料]
    O9 --> O10[清除 DMA 中苏I<br/>DMA_ClearITPendingBit]
    O10 --> P[DMA 中喾祷]
    
    Q[UART fh位元M理<br/>UART2_Receive_Byte_ISR] --> R{z查封包起始}
    R -->|START_MARK| S[_始新封包接收]
    S --> S1[重O接收索引]
    S1 --> S2[O定接收B]
    S2 --> T
    
    R -->|Y料位元M| T[⑽辉M存入接收n^]
    T --> T1[z查n^溢位]
    T1 --> T2[增加接收索引]
    T2 --> U{z查封包完整性}
    
    U -->|END_MARK| V[封包接收完成]
    V --> V1[C封包z和]
    V1 --> V2{z和正_?}
    V2 -->|是| V3[O定 packet_received 苏I]
    V2 -->|否| V4[G封包，e`]
    V3 --> W[封包理完成]
    V4 --> W
    
    U -->|^m接收| X[等待更多Y料]
    X --> W
    
    style A fill:#e3f2fd
    style N fill:#e3f2fd
    style Q fill:#f3e5f5