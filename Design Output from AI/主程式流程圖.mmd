flowchart TD
    A[主圈_始] --> B[UART fh理<br/>UART_Protocol_Process]
    B --> B1[z查封包接收]
    B1 --> B2{有完整封包?}
    B2 -->|是| B3[解析K理封包<br/>UART_ProcessPacket]
    B2 -->|否| C
    B3 --> B4[重O接收]
    B4 --> C[片zy理<br/>STRIP_DETECT_Process]
    
    C --> C1{片B?}
    C1 -->|INSERTED| C2[⒂ T1 y量路<br/>PA8 O榈碗平]
    C2 --> C3[延t 10ms 等待定]
    C3 --> C4[x取 T1 <br/>PA6/ADC_Channel_6]
    C4 --> C5[判e片型<br/>根_位和]
    C5 --> C6[保存片型到当]
    C6 --> C7[O置 W O PWM 卓毡]
    C7 --> C8[l送片型到 CH582F]
    C8 --> C9[切Q到 STATE_WAIT_FOR_BLOOD]
    C9 --> C10[P] T1 y量路<br/>PA8 O楦唠平]
    C10 --> D
    C1 -->|其他| D
    
    D[BC理<br/>State_Process] --> E{前系yB?}
    
    E -->|STATE_IDLE| F[空fB理]
    F --> F1[等待片插入]
    F1 --> Z
    
    E -->|STATE_WAIT_FOR_BLOOD| G[等待血液B理]
    G --> G1[x取 GLU_OUT ADC 值<br/>PA4/ADC_Channel_4]
    G1 --> G2[配置 ADC 通道 4]
    G2 --> G3[ ADC DQ]
    G3 --> G4[等待DQ完成<br/>z查 ADC_FLAG_EOC]
    G4 --> G5[@取 ADC 值]
    G5 --> G6[当慝@取血液zy值]
    G6 --> G7{ADC 值 > 值?}
    G7 -->|是| G8[zy到血液<br/>切Q到 STATE_MEASURING]
    G7 -->|否| Z
    G8 --> Z
    
    E -->|STATE_MEASURING| H[y量B理]
    H --> H1[d入r序<br/>evWidth1, tpl1, trd1<br/>evWidth2, tpl2, trd2]
    H1 --> H2[系y毫秒灯鞲新<br/>+10ms]
    H2 --> H3{y量步E?}
    
    H3 -->|Step 1| H4[PWM 出控制<br/>PB15, evWidth1 rg]
    H4 --> H5[⒂ PWM<br/>TIM_CtrlPWMOutputs ENABLE]
    H5 --> H6{rg_到 evWidth1?}
    H6 -->|否| H4
    H6 -->|是| H7[Step 2: 切Q到高平出]
    H7 --> H8[禁用 PWM, O定 PB15  HIGH]
    H8 --> H9{rg_到 tpl1?}
    H9 -->|否| H8
    H9 -->|是| H10[Step 3: 重新⒂ PWM]
    H10 --> H11{rg_到 trd1?}
    H11 -->|否| H10
    H11 -->|是| H12{tpl2 == 0?}
    H12 -->|是| H20[跳到 Step 7]
    H12 -->|否| H13[Step 4: ^m PWM evWidth2]
    H13 --> H14{rg_到 evWidth2?}
    H14 -->|否| H13
    H14 -->|是| H15[Step 5: HIGH tpl2]
    H15 --> H16{rg_到 tpl2?}
    H16 -->|否| H15
    H16 -->|是| H17[Step 6: PWM trd2]
    H17 --> H18{rg_到 trd2?}
    H18 -->|否| H17
    H18 -->|是| H20
    H20 --> H21[Step 7: 精_ ADC y量<br/>GetMidADC 函]
    H21 --> H22[100次Bm取]
    H22 --> H23[馀菖判]
    H23 --> H24[取中g20值平均]
    H24 --> H25[存入 W_ADC ]
    H25 --> H26[停止 PWM 出<br/>PB15 O HIGH]
    H26 --> H27[切Q到 STATE_RESULT_READY]
    H27 --> Z
    
    E -->|STATE_RESULT_READY| I[Y果B理]
    I --> I1[呼叫血糖算函<br/>CalGlucose 使用 W_ADC]
    I1 --> I2[ ADC 值DQ檠糖值]
    I2 --> I3[@示y量Y果<br/>血糖值和挝]
    I3 --> I4[擞算完成]
    I4 --> Z
    
    E -->|STATE_ERROR| J[e`B理]
    J --> J1[e`Y]
    J1 --> J2[停止所有y量幼]
    J2 --> J3[重置相P]
    J3 --> J4[可x：自踊突虻却手又刂]
    J4 --> Z
    
    E -->|其他B| K[未知B理]
    K --> K1[重置 STATE_IDLE]
    K1 --> Z
    
    Z[延t 5ms] --> A
    
    style A fill:#fff3e0
    style H fill:#e8f5e8
    style I fill:#fff8e1
    style J fill:#ffebee
    style C fill:#e3f2fd