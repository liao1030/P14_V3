# P14多功能生化x{牙cUART通fh

## 概述
本文n定xP14多功能生化x的{牙cUART通fh，用於手CAPPcx器之g的交Q。fhm用於以下通道：
1. 手CAPP <-> {牙模M(CH582F)
2. {牙模M(CH582F) <-> 主控MCU(CH32V203G8R6)

## 通模型
通裼弥氖郊：
- 手CAPP橹髟O洌l起求
- 生化x脑O洌求

## fh格式

### 包格式
每通包由以下部分M成：

| 谖       | L度(字) | 描述                           |
|------------|------------|--------------------------------|
| 起始擞   | 1          | 固定 0xAA                    |
| 命令ID     | 1          | 命令俗R符                     |
| L度   | 1          | ^L度N (0-64)             |
|        | N          | 热 (可L度，最大64字) |
| 校和     | 1          | 命令ID和的算g和取低8位     |
| Y束擞   | 1          | 固定 0x55                    |

### 命令ID定x

| 命令ID | 方向       | 描述                 |
|--------|------------|----------------------|
| 0x01   | APP -> x器 | 同步rg             |
| 0x81   | x器 -> APP | rg同步_J         |
| 0x02   | APP -> x器 | 求OB         |
| 0x82   | x器 -> APP | OB回         |
| 0x03   | APP -> x器 | O定CODE和EVENT      |
| 0x83   | x器 -> APP | CODE/EVENTO定_J   |
| 0x04   | APP -> x器 | zyB求         |
| 0x84   | x器 -> APP | 血液zy通知         |
| 0x05   | APP -> x器 | 求zyY果         |
| 0x85   | x器 -> APP | zyY果回         |
| 0x06   | APP -> x器 | 求RAW DATA         |
| 0x86   | x器 -> APP | RAW DATA回         |
| 0xFF   | x器 -> APP | e`回             |

### e`代a

| e`代a | 描述                   |
|----------|------------------------|
| 0x01     | 池量^低           |
| 0x02     | 囟冗^高               |
| 0x03     | 囟冗^低               |
| 0x04     | ^期或p         |
| 0x05     | 已使用             |
| 0x06     | 插入e`           |
| 0x07     | 血液颖静蛔           |
| 0x08     | zy超r               |
| 0x09     | 校正e`               |
| 0x0A     | 硬件e`               |
| 0x0B     | 通e`               |
| 0x0C     | Y料格式e`           |
| 0x0D     | 校和e`             |
| 0x0E     | 指令不支持             |
| 0x0F     | zyY果超出       |

## 命令解

### 1. 同步rg (0x01/0x81)
用於同步x器rg。

**求 (APP -> x器)**
格式：
- 年份 (2字，高字在前)
- 月份 (1字)
- 日期 (1字)
- r (1字)
- 分 (1字)
- 秒 (1字)

**回 (x器 -> APP)**
格式：
- B (1字): 0x00表示成功，其他表示失

### 2. 求OB (0x02/0x82)
用於@取O洚前B。

**求 (APP -> x器)**
o。

**回 (x器 -> APP)**
格式：
- zy目 (2字，高字在前)
- B (2字，高字在前)
- 池 (2字，高字在前，挝mV)
- 囟 (2字，高字在前，放大10倍)

### 3. O定CODE和EVENT (0x03/0x83)
用於O定校正a和y事件型。

**求 (APP -> x器)**
格式：
- 校正a (1字)
- 事件型 (2字，高字在前)

**回 (x器 -> APP)**
格式：
- B (1字): 0x00表示成功，其他表示失

### 4. zyB求 (0x04/0x84)
用於查或通知血液zyB。

**求 (APP -> x器)**
o。

**回 (x器 -> APP)**
格式：
- 倒r (1字): 剩N秒担0表示完成

### 5. 求zyY果 (0x05/0x85)
用於@取最近一次zyY果。

**求 (APP -> x器)**
o。

**回 (x器 -> APP)**
格式：
- Y果B (2字，高字在前)
- zy值 (2字，高字在前)
- zy目 (2字，高字在前)
- 事件型 (2字，高字在前)
- 校正a (1字)
- yrg (12字):
  - 年份 (2字，高字在前)
  - 月份 (2字，高字在前)
  - 日期 (2字，高字在前)
  - r (2字，高字在前)
  - 分 (2字，高字在前)
  - 秒 (2字，高字在前)
- 池 (2字，高字在前，挝mV)
- 囟 (2字，高字在前，放大10倍)

### 6. 求RAW DATA (0x06/0x86)
用於@取zy原始。

**求 (APP -> x器)**
o。

**回 (x器 -> APP)**
格式：
- 段 (2字，高字在前)
- 原始 (L，根yH情r)

### 7. e`回 (0xFF)
用於通知e`情r。

**回 (x器 -> APP)**
格式：
- 原始命令ID (1字)
- e`代a (1字)

## fh理

### 校和算
校和的算方法如下：
```
校和 = (命令ID + 1 + 2 + ... + N) & 0xFF
```

### 型定x
- zy目：
  - 0x0000: 血糖(GLV)
  - 0x0001: 尿酸(U)
  - 0x0002: 固醇(C)
  - 0x0003: 三酸甘油脂(TG)
  - 0x0004: 血糖(GAV)

- 事件型：
  - 0x0000: o
  - 0x0001: AC(前)
  - 0x0002: PC(後)
  - 0x0003: QC(品|控制)

### 通流程例
1. APP先求OB，_JO淇捎
2. APPO定CODE和EVENT
3. APP求zyB
4. APP收到血液zy通知，等待倒rY束
5. APP求yY果

### e`理
- 通超r：如果在3秒任词盏巾，可重新l送求，最多重3次
- 校和e`：重新l送求
- 格式e`：z查格式K重新l送

## 附
### 示例：rg同步求
```
AA 01 07 07 E7 04 1C 0F 1E 00 C9 55
```
- 起始擞: 0xAA
- 命令ID: 0x01 (同步rg)
- L度: 0x07 (7字)
- : 0x07E7 (2023年) 0x04 (4月) 0x1C (28日) 0x0F (15r) 0x1E (30分) 0x00 (0秒)
- 校和: 0xC9
- Y束擞: 0x55

### 示例：OB回
```
AA 82 08 00 00 00 00 0B B8 00 FA 41 55
```
- 起始擞: 0xAA
- 命令ID: 0x82 (OB回)
- L度: 0x08 (8字)
- : 0x0000 (血糖) 0x0000 (正常) 0x0BB8 (3000mV) 0x00FA (25.0°C)
- 校和: 0x41
- Y束擞: 0x55 